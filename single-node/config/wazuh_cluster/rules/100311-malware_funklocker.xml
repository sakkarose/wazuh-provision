<group name="funklocker,ransomware,malware,">
  <!-- Windows Defender Real-time Protection disabled-->
  <rule id="100311" level="12">
    <if_sid>61603</if_sid>
   <field name="win.eventdata.parentImage" type="pcre2">\.exe|\.bin|\.ps1|\.vbs|\.dll|\.js</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)Set-MpPreference\s+-DisableRealtimeMonitoring</field>
    <description>Possible malware infection: Windows Defender disabled via PowerShell.</description>
    <mitre>
      <id>T1562.001</id>
    </mitre>
  </rule>

 <!-- Windows Security event log disabled-->
  <rule id="100312" level="12">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.parentImage" type="pcre2">\.exe|\.bin|\.ps1|\.vbs|\.dll|\.js</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)wevtutil\s+sl\s+Security</field>
    <description>Possible malware infection: Windows Security event log disabled.</description>
    <mitre>
      <id>T1070.001</id>
      <id>T1059.001</id>
    </mitre>
  </rule>

  <!-- Windows Application event log disabled -->
  <rule id="100313" level="12">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.parentImage" type="pcre2">\.exe|\.bin|\.ps1|\.vbs|\.dll|\.js</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)wevtutil\s+sl\s+Application</field>
    <description>Possible malware infection: Windows Application event log disabled.</description>
    <mitre>
      <id>T1070.001</id>
    </mitre>
  </rule>

  <!-- PowerShell execution policy bypass -->
  <rule id="100314" level="12">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.parentImage" type="pcre2">\.exe|\.bin|\.ps1|\.vbs|\.dll|\.js</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)Set-ExecutionPolicy</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)Bypass</field>
    <description>Possible malware infection: PowerShell execution policy set to bypass.</description>
    <mitre>
      <id>T1059.001</id>
    </mitre>
  </rule>

  <!-- Detect process termination by taskkill -->
  <rule id="100315" level="2">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.parentImage" type="pcre2">\.exe|\.bin|\.ps1|\.vbs|\.dll|\.js</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)taskkill</field>
    <field name="win.eventdata.commandLine" type="pcre2">\/F\s+\/IM</field>
    <description>Process terminated using taskkill. Command: $(win.eventdata.CommandLine). Suspicious activity.</description>
    <mitre>
      <id>T1489</id>
    </mitre>
  </rule>
  
  <!-- Detect multiple process termination by taskkill -->
  <rule id="100316" level="15" frequency="10" timeframe="300">
    <if_matched_sid>100315</if_matched_sid>
    <description>Possible Funklocker ransomware activity: Multiple processes terminated with taskkill.</description>
    <mitre>
      <id>T1489</id>
    </mitre>
  </rule>

  <!-- Detect stopping of Windows services using sc.exe -->
  <rule id="100317" level="2">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.parentImage" type="pcre2">\.exe|\.bin|\.ps1|\.vbs|\.dll|\.js</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)sc</field>
    <field name="win.eventdata.commandLine" type="pcre2">stop</field>
    <description>Service stopped with sc.exe. Command: $(win.eventdata.CommandLine). Suspicious activity.</description>
    <mitre>
      <id>T1489</id>
      <id>T1543.003</id>
    </mitre>
  </rule>
  
  <!-- Detect multiple process termination by taskkill -->
  <rule id="100318" level="15" frequency="10" timeframe="300">
    <if_matched_sid>100317</if_matched_sid>
    <description>Possible Funklocker ransomware activity: Multiple processes terminated with sc utility.</description>
    <mitre>
      <id>T1489</id>
    </mitre>
  </rule>

  <!-- Detect VSS deletion (removal of shadow copies) -->
  <rule id="100319" level="15">
    <if_sid>61603</if_sid>
    <field name="win.eventdata.parentImage" type="pcre2">\.exe|\.bin|\.ps1|\.vbs|\.dll|\.js</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)vssadmin</field>
    <field name="win.eventdata.commandLine" type="pcre2">delete\s+shadows</field>
    <description>Volume Shadow Copy Service backups deleted. Possible Funklocker ransomware activity.</description>
    <mitre>
      <id>T1490</id>
    </mitre>
  </rule>
  
  <!-- Detect creation of encrypted files with .funksec extension -->
  <rule id="100320" level="15">
    <if_sid>61613</if_sid>
    <field name="win.eventdata.Image" type="pcre2">\.exe|\.bin|\.ps1|\.vbs|\.dll|\.js</field>
    <field name="win.eventdata.targetFilename" type="pcre2">(?i)\.funksec$</field>
    <description>Possible Funklocker ransomware: Encrypted file detected with .funksec extension - $(win.eventdata.targetFilename).</description>
    <mitre>
      <id>T1486</id>
    </mitre>
  </rule>
</group>