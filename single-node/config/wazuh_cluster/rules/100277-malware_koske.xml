<group name="koske, malware,">

 <!-- Extract - Detect extraction of shellcode/C code from JPEGs, in-memory compilation/execution -->


  <rule id="100277" level="7" frequency="2" ignore="120">
    <if_sid>100011</if_sid>
    <field name="eventdata.Image" type="pcre2">^/usr/bin/(bash|sh|dd|tail|head|gcc|ld)$</field>
    <field name="eventdata.CommandLine" type="pcre2">skip=[0-9]+ bs=1 if=.*\.jpeg of=.*\.(sh|c)$</field>   
    <description>Possible Koske malware activity: Extraction of shellcode from JPEG $(eventdata.CommandLine) into a shell script for execution.</description>
    <mitre>
      <id>T1059</id>  <!-- Command and Scripting Interpreter -->
      <id>T1027</id>  <!-- Obfuscated Files or Information -->
    </mitre>
  </rule>


 <!-- Download - Curl creating .koske miner files -->
  <rule id="100278" level="7">
    <if_sid>100015</if_sid>
    <field name="eventdata.Image" type="pcre2">^/usr/bin/curl$</field>
    <field name="eventdata.TargetFilename" type="pcre2">\.(koske)$</field> 
    <field name="eventdata.TargetFilename" type="pcre2">nanominer|SRBMiner-Multi|cpuMinerTermux|cpuMinerRplant</field> <!-- Specific miner names -->
    <description>Koske malware activity: Download of miner payload via curl $(eventdata.TargetFilename).</description>
    <mitre>
      <id>T1105</id> <!-- Ingress Tool Transfer -->
    </mitre>
  </rule>


  <!-- Rule for Persistence/Evasion - .bashrc modifications-->
    <rule id="100279" level="9">
    <if_sid>100015, 100011</if_sid> 
    <field name="eventdata.Image" type="pcre2">^/usr/bin/(bash|chmod|grep)$</field>
    <field name="eventdata.TargetFilename" type="pcre2">\.bashrc\.koske$</field>
    <description>Koske malware persistence: creation of modified bashrc file $(eventdata.TargetFilename) to maintain access.</description>
    <mitre>
      <id>T1546.004</id>
    </mitre>
  </rule>


  <rule id="100280" level="9">
    <if_sid>100015</if_sid>
    <field name="eventdata.Image" type="pcre2">^/usr/bin/bash$</field>
    <field name="eventdata.TargetFilename" type="pcre2">^/dev/shm/\.hiddenpid$</field>  
    <description>Koske malware activity: Creation of rootkit persistence file $(eventdata.TargetFilename) for process hiding.</description>
    <mitre>
      <id>T1562</id>  
      <id>T1014</id> 
    </mitre>
  </rule>

  <rule id="100281" level="12" frequency="2" ignore="120">
    <if_sid>100011, 100018</if_sid> 
    <field name="eventdata.Image" type="pcre2">cpuminer-sse2|nanominer|/usr/bin/pgrep</field>
    <field name="eventdata.CommandLine" type="pcre2">yespowertide|stratum-eu\.rplant\.xyz:7059|VRSC|eu\.luckpool\.net:3956|pgrep \./nanominer</field> <!-- Miner cmds/pools -->
    <description>Koske malware activity: Execution of cryptominer $(eventdata.Image) with mining command $(eventdata.CommandLine).</description>
    <mitre>
      <id>T1496</id> <!-- Resource Hijacking -->
    </mitre>
  </rule>

  <rule id="100282" level="9">
    <if_sid>100018</if_sid> 
    <field name="eventdata.Image" type="pcre2">nanominer</field>
    <field name="eventdata.Protocol" type="pcre2">tcp</field>
    <field name="eventdata.DestinationIp" type="pcre2">79\.137\.70\.48</field> <!-- Luckpool IP from log -->
    <description>Koske malware activity: Cryptominer $(eventdata.Image) established TCP connection to mining pool $(eventdata.DestinationIp):$(eventdata.DestinationPort)</description>
    <mitre>
      <id>T1496</id>
    </mitre>
  </rule>

  <rule id="100283" level="13">
    <if_sid>554, 550</if_sid>
    <list field="sha256" lookup="match_key">etc/lists/malware_koske</list>
    <description>A known Koske malware hash detected: $(file)</description>
    <mitre>
      <id>T1204.002</id>
    </mitre>
  </rule>

</group>